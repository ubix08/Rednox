
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>RedNox ‚Äì Flow Builder</title>
<style>
/* --------------  DESIGN SYSTEM -------------- */
:root{
  --p:#6366f1;--pd:#4f46e5;--pl:#818cf8;--s:#10b981;--d:#ef4444;--w:#f59e0b;
  --bg:#0f172a;--bgl:#1e293b;--bgll:#334155;--surface:#1e293b;--t:#f1f5f9;--tm:#94a3b8;--b:#334155;--sh:rgba(0,0,0,.3);
  --radius:12px;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:var(--font);background:var(--bg);color:var(--t);height:100vh;overflow:hidden}
button{border:none;background:none;color:inherit;font:inherit;cursor:pointer}
/* --------------  HEADER -------------- */
header{background:var(--surface);border-bottom:1px solid var(--b);padding:.75rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem;z-index:1000}
.logo{display:flex;align-items:center;gap:.5rem;font-weight:600;font-size:1.1rem}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--p),var(--pl));border-radius:8px;display:grid;place-content:center;font-weight:bold}
.flow-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:.95rem;color:var(--tm)}
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .9rem;border-radius:var(--radius);font-size:.85rem;font-weight:500;transition:all .2s}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px var(--sh)}
.btn-primary{background:var(--p);color:#fff}
.btn-success{background:var(--s);color:#fff}
.back-btn{display:none;font-size:1.4rem;padding:.4rem;border-radius:8px}
.back-btn.visible{display:flex}
/* --------------  VIEWS -------------- */
main{flex:1;display:flex;position:relative}
.flows-view,.canvas-view{width:100%;height:100%;display:none}
.flows-view.active,.canvas-view.active{display:flex}
.flows-container{padding:1.25rem;max-width:1400px;margin:auto;display:flex;flex-direction:column;gap:1rem;overflow-y:auto}
.flow-card{background:var(--surface);border:1px solid var(--b);border-radius:var(--radius);padding:1.25rem;display:flex;flex-direction:column;gap:.75rem;transition:all .25s}
.flow-card:hover{border-color:var(--p);box-shadow:0 8px 24px rgba(99,102,241,.15);transform:translateY(-2px)}
.flow-header{display:flex;justify-content:space-between;gap:1rem}
.flow-name{font-weight:600;font-size:1.05rem;display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
.badge{font-size:.65rem;padding:.25rem .5rem;border-radius:4px;text-transform:uppercase;font-weight:600}
.badge-success{background:rgba(16,185,129,.15);color:var(--s)}
.badge-danger{background:rgba(239,68,68,.15);color:var(--d)}
.flow-desc{font-size:.85rem;color:var(--tm);margin:.25rem 0}
.flow-meta{font-size:.75rem;color:var(--tm);display:flex;gap:1rem}
.flow-actions{display:flex;gap:.5rem;flex-wrap:wrap}
.action-btn{padding:.45rem .7rem;background:var(--bgl);border:1px solid var(--b);border-radius:6px;font-size:.75rem;display:inline-flex;align-items:center;gap:.3rem;transition:all .2s}
.action-btn:hover{background:var(--bgll);border-color:var(--p);transform:translateY(-1px)}
.action-btn.primary{background:var(--p);color:#fff;border-color:var(--p)}
.action-btn.danger{background:transparent;border-color:var(--d);color:var(--d)}
.action-btn.danger:hover{background:var(--d);color:#fff}
.empty-state{text-align:center;padding:4rem 1rem;color:var(--tm)}
.empty-icon{font-size:3rem;margin-bottom:.75rem;opacity:.4}
/* --------------  CANVAS -------------- */
#drawflow{width:100%;height:100%;background:var(--bg);background-image:radial-gradient(circle,var(--b) 1px,transparent 1px);background-size:24px 24px;touch-action:none}
.canvas-toolbar{position:absolute;top:1rem;left:1rem;display:flex;gap:.5rem;background:var(--surface);border:1px solid var(--b);border-radius:var(--radius);padding:.5rem;box-shadow:0 4px 16px var(--sh);z-index:100}
.toolbar-btn{width:36px;height:36px;border-radius:8px;display:grid;place-content:center;font-size:1.1rem;transition:all .2s}
.toolbar-btn:hover{background:var(--bgl);color:var(--pl)}
/* --------------  NODES -------------- */
.drawflow-node{background:transparent;border:none;box-shadow:none;padding:0;width:100px;min-height:100px;display:flex;flex-direction:column;align-items:center;cursor:move}
.drawflow-node.selected .node-content{box-shadow:0 0 0 3px rgba(99,102,241,.4),0 6px 20px rgba(0,0,0,.3);transform:scale(1.03)}
.node-content{display:flex;flex-direction:column;align-items:center;gap:6px;width:100%;transition:all .25s}
.drawflow-node:hover .node-content{transform:scale(1.05)}
.node-icon-wrapper{width:56px;height:56px;border-radius:50%;display:grid;place-content:center;box-shadow:0 4px 12px rgba(0,0,0,.25);transition:all .25s}
.node-icon{font-size:1.75rem;color:#fff}
.node-name{font-size:.75rem;font-weight:600;text-align:center;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;background:var(--surface);padding:.25rem .5rem;border-radius:6px;border:1px solid var(--b)}
/* --------------  CONNECTIONS -------------- */
.input,.output{width:14px;height:14px;background:var(--p);border:2px solid var(--bg);border-radius:50%;position:absolute;z-index:10;transition:all .2s}
.input:hover,.output:hover{background:var(--pl);transform:scale(1.3)}
.input{left:-7px;top:50%;transform:translateY(-50%)}
.output{right:-7px;top:50%;transform:translateY(-50%)}
.outputs{position:absolute;right:-7px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:8px}
.main-path{stroke:var(--p);stroke-width:2.5;fill:none;stroke-linecap:round;stroke-dasharray:5 5;animation:dash 20s linear infinite}
@keyframes dash{to{stroke-dashoffset:-100}}
/* --------------  PALETTE -------------- */
.node-palette{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--b);border-radius:20px 20px 0 0;box-shadow:0 -4px 24px var(--sh);transform:translateY(100%);transition:transform .3s;z-index:2000;max-height:75vh;display:flex;flex-direction:column}
.node-palette.active{transform:translateY(0)}
.palette-handle{width:48px;height:5px;background:var(--b);border-radius:3px;margin:.75rem auto}
.palette-header{padding:0 1.25rem 1rem;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between}
.palette-title{font-size:1.1rem;font-weight:600}
.close-btn{font-size:1.5rem;width:32px;height:32px;border-radius:8px;display:grid;place-content:center;transition:all .2s}
.close-btn:hover{background:var(--bgl)}
.palette-content{flex:1;overflow-y:auto;padding:1.25rem}
.node-category{margin-bottom:1.5rem}
.category-title{font-size:.65rem;font-weight:700;text-transform:uppercase;color:var(--tm);letter-spacing:.1em;margin-bottom:.5rem}
.node-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:.75rem}
.node-item{padding:1rem .75rem;background:var(--bgl);border:1px solid var(--b);border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:.5rem;text-align:center;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s}
.node-item:hover{border-color:var(--p);background:var(--bgll);transform:translateY(-2px)}
.node-item-icon{width:52px;height:52px;border-radius:50%;display:grid;place-content:center;font-size:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2)}
.search-input{width:100%;margin-bottom:1rem}
/* --------------  PROPERTIES -------------- */
.properties-panel{position:fixed;right:0;top:57px;bottom:0;width:100%;max-width:360px;background:var(--surface);border-left:1px solid var(--b);box-shadow:-4px 0 24px var(--sh);transform:translateX(100%);transition:transform .3s;z-index:1500;display:flex;flex-direction:column}
.properties-panel.active{transform:translateX(0)}
.properties-header{padding:1rem 1.25rem;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between}
.properties-title{font-size:1rem;font-weight:600}
.properties-content{flex:1;overflow-y:auto;padding:1.25rem}
.form-group{margin-bottom:1rem}
.form-label{display:block;font-size:.75rem;font-weight:600;margin-bottom:.5rem;color:var(--tm);text-transform:uppercase;letter-spacing:.025em}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem;background:var(--bgl);border:1px solid var(--b);border-radius:8px;color:var(--t);font-family:inherit;font-size:.95rem;transition:all .2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--p);box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.form-textarea{resize:vertical;min-height:140px;font-family:monospace;font-size:.85rem}
/* --------------  MODAL -------------- */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:3000;padding:1rem;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:var(--surface);border-radius:var(--radius);padding:1.5rem;width:100%;max-width:520px;box-shadow:0 24px 48px rgba(0,0,0,.4)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.modal-title{font-size:1.25rem;font-weight:600}
/* --------------  TOAST -------------- */
.toast{position:fixed;bottom:1.25rem;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--b);border-left:4px solid var(--p);border-radius:var(--radius);padding:1rem 1.25rem;box-shadow:0 8px 24px var(--sh);z-index:4000;display:flex;align-items:center;gap:.75rem;min-width:280px;max-width:90vw;animation:slideUp .3s}
@keyframes slideUp{from{transform:translate(-50%,100px);opacity:0}to{transform:translate(-50%,0);opacity:1}}
.toast-icon{font-size:1.25rem}
.toast-message{flex:1;font-size:.9rem;font-weight:500}
.toast.success{border-left-color:var(--s)}
.toast.error{border-left-color:var(--d)}
/* --------------  LOADER -------------- */
.loading{width:24px;height:24px;border:3px solid var(--b);border-top-color:var(--p);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* --------------  SCROLLBAR -------------- */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--bgl)}
::-webkit-scrollbar-thumb{background:var(--b);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--bgll)}
/* --------------  RESPONSIVE -------------- */
@media (max-width:768px){
  .properties-panel{top:0;max-width:100%;border-left:none;border-radius:20px 20px 0 0;transform:translateY(100%)}
  .properties-panel.active{transform:translateY(0)}
  .node-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-left">
      <button class="back-btn" id="backBtn" onclick="showFlowsList()">‚Üê</button>
      <div class="logo"><div class="logo-icon">R</div><span>RedNox</span></div>
      <div class="flow-title" id="flowTitle"></div>
    </div>
    <div id="headerActions">
      <button class="btn btn-primary" onclick="showNewFlowModal()">+ New Flow</button>
    </div>
  </header>

  <main>
    <!-- FLOW LIST -->
    <div class="flows-view active" id="flowsView">
      <div class="flows-container" id="flowsContainer">
        <div class="empty-state"><div class="loading"></div><p>Loading flows‚Ä¶</p></div>
      </div>
    </div>

    <!-- CANVAS -->
    <div class="canvas-view" id="canvasView">
      <div id="drawflow"></div>
      <div class="canvas-toolbar">
        <button class="toolbar-btn" onclick="showNodePalette()" title="Add node">+</button>
        <button class="toolbar-btn" onclick="editor.zoom_in()" title="Zoom in">üîç+</button>
        <button class="toolbar-btn" onclick="editor.zoom_out()" title="Zoom out">üîç‚àí</button>
        <button class="toolbar-btn" onclick="editor.zoom_reset()" title="Reset zoom">‚äô</button>
        <button class="toolbar-btn" onclick="zoomToFit()" title="Fit to screen">‚§ß</button>
        <button class="toolbar-btn" onclick="saveFlow()" title="Save">üíæ</button>
        <button class="toolbar-btn" onclick="showHelp()" title="Shortcuts">?</button>
      </div>
    </div>
  </main>
</div>

<!-- NODE PALETTE -->
<div class="node-palette" id="nodePalette">
  <div class="palette-handle"></div>
  <div class="palette-header">
    <h3 class="palette-title">Add Node</h3>
    <button class="close-btn" onclick="closeNodePalette()">√ó</button>
  </div>
  <div class="palette-content">
    <input class="form-input search-input" id="paletteSearch" placeholder="Search nodes‚Ä¶" oninput="filterPalette()" />
    <div id="nodePaletteContent"></div>
  </div>
</div>

<!-- PROPERTIES -->
<div class="properties-panel" id="propertiesPanel">
  <div class="properties-header">
    <h3 class="properties-title">Properties</h3>
    <button class="close-btn" onclick="closeProperties()">√ó</button>
  </div>
  <div class="properties-content" id="propertiesContent">
    <p style="color:var(--tm);text-align:center;padding:2rem">Select a node</p>
  </div>
</div>

<!-- NEW FLOW MODAL -->
<div class="modal" id="newFlowModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Create Flow</h3>
      <button class="close-btn" onclick="closeModal('newFlowModal')">√ó</button>
    </div>
    <div class="form-group">
      <label class="form-label">Flow ID *</label>
      <input class="form-input" id="newFlowId" placeholder="my-flow" />
    </div>
    <div class="form-group">
      <label class="form-label">Name *</label>
      <input class="form-input" id="newFlowName" placeholder="My Flow" />
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea class="form-textarea" id="newFlowDesc" style="min-height:100px"></textarea>
    </div>
    <div style="display:flex;gap:.75rem;margin-top:1.5rem">
      <button class="btn" style="flex:1" onclick="closeModal('newFlowModal')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="createNewFlow()">Create</button>
    </div>
  </div>
</div>

<!-- HELP MODAL -->
<div class="modal" id="helpModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Keyboard shortcuts</h3>
      <button class="close-btn" onclick="closeModal('helpModal')">√ó</button>
    </div>
    <ul style="font-size:.9rem;color:var(--tm);list-style:none;display:flex;flex-direction:column;gap:.5rem">
      <li><strong>Ctrl S</strong> ‚Äì Save flow</li>
      <li><strong>Ctrl Z</strong> ‚Äì Undo</li>
      <li><strong>Ctrl Y</strong> ‚Äì Redo</li>
      <li><strong>+</strong> ‚Äì Open palette</li>
    </ul>
  </div>
</div>

<script>
/* --------------  CONFIG -------------- */
const API_BASE = window.location.origin;
let editor, currentFlow = null, flows = [];
let undoStack = [], redoStack = [], undoing = false;
const nodeTemplates = {
  'http-in':{icon:'üåê',name:'HTTP In',cat:'Input',color:'#6366f1',inputs:0,outputs:1},
  'http-response':{icon:'üì§',name:'HTTP Response',cat:'Output',color:'#10b981',inputs:1,outputs:0},
  'http-request':{icon:'üîó',name:'HTTP Request',cat:'Function',color:'#f59e0b',inputs:1,outputs:1},
  function:{icon:'‚ö°',name:'Function',cat:'Function',color:'#f59e0b',inputs:1,outputs:1},
  inject:{icon:'üíâ',name:'Inject',cat:'Input',color:'#6366f1',inputs:0,outputs:1},
  debug:{icon:'üêõ',name:'Debug',cat:'Output',color:'#10b981',inputs:1,outputs:0},
  switch:{icon:'üîÄ',name:'Switch',cat:'Function',color:'#f59e0b',inputs:1,outputs:3},
  change:{icon:'‚úèÔ∏è',name:'Change',cat:'Function',color:'#f59e0b',inputs:1,outputs:1},
  template:{icon:'üìù',name:'Template',cat:'Function',color:'#f59e0b',inputs:1,outputs:1},
  json:{icon:'{ }',name:'JSON',cat:'Parser',color:'#f59e0b',inputs:1,outputs:1},
  delay:{icon:'‚è±Ô∏è',name:'Delay',cat:'Function',color:'#f59e0b',inputs:1,outputs:1},
  split:{icon:'‚úÇÔ∏è',name:'Split',cat:'Sequence',color:'#f59e0b',inputs:1,outputs:1},
  join:{icon:'üîó',name:'Join',cat:'Sequence',color:'#f59e0b',inputs:1,outputs:1},
  context:{icon:'üíæ',name:'Context',cat:'Storage',color:'#6366f1',inputs:1,outputs:1},
  catch:{icon:'‚ö†Ô∏è',name:'Catch',cat:'Input',color:'#6366f1',inputs:0,outputs:1}
};

/* --------------  INIT -------------- */
window.onload = () => loadFlows();

/* --------------  FLOW LIST -------------- */
async function loadFlows(){
  try{
    const res = await fetch(`${API_BASE}/admin/flows`);
    const data = await res.json();
    flows = data.flows||[];
    renderFlows();
  }catch(e){
    document.getElementById('flowsContainer').innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Failed to load flows</p></div>`;
  }
}
function renderFlows(){
  const c = document.getElementById('flowsContainer');
  if(!flows.length){
    c.innerHTML = `<div class="empty-state"><div class="empty-icon">üì¶</div><h3>No flows yet</h3><p>Create your first flow</p></div>`;
    return;
  }
  c.innerHTML = flows.map(f=>{
    const cfg = typeof f.config==='string'?JSON.parse(f.config):f.config;
    const nodes = cfg.nodes?.length||0;
    return `<div class="flow-card" data-id="${f.id}">
      <div class="flow-header">
        <div class="flow-info">
          <div class="flow-name">${f.name} <span class="badge ${f.enabled?'badge-success':'badge-danger'}">${f.enabled?'‚óè Active':'‚óã Disabled'}</span></div>
          ${f.description?`<div class="flow-desc">${f.description}</div>`:''}
          <div class="flow-meta"><span>üî∑ ${nodes} nodes</span><span>üÜî ${f.id}</span></div>
        </div>
      </div>
      <div class="flow-actions">
        <button class="action-btn primary" onclick="openFlow('${f.id}')">üìä Open</button>
        <button class="action-btn" onclick="duplicateFlow('${f.id}')">üìã Copy</button>
        <button class="action-btn ${f.enabled?'':'primary'}" onclick="toggleFlow('${f.id}',${!f.enabled})">${f.enabled?'‚è∏ Disable':'‚ñ∂ Enable'}</button>
        <button class="action-btn danger" onclick="deleteFlow('${f.id}')">üóë Delete</button>
      </div>
    </div>`;
  }).join('');
}
function showFlowsList(){
  document.getElementById('flowsView').classList.add('active');
  document.getElementById('canvasView').classList.remove('active');
  document.getElementById('backBtn').classList.remove('visible');
  document.getElementById('flowTitle').textContent='';
  document.getElementById('headerActions').innerHTML='<button class="btn btn-primary" onclick="showNewFlowModal()">+ New Flow</button>';
  closeProperties(); closeNodePalette(); currentFlow=null;
}

/* --------------  CANVAS -------------- */
async function openFlow(id){
  const res = await fetch(`${API_BASE}/admin/flows/${id}`);
  currentFlow = await res.json();
  document.getElementById('flowsView').classList.remove('active');
  document.getElementById('canvasView').classList.add('active');
  document.getElementById('backBtn').classList.add('visible');
  document.getElementById('flowTitle').textContent=currentFlow.name;
  document.getElementById('headerActions').innerHTML='<button class="btn btn-success" onclick="saveFlow()">üíæ Save</button>';
  if(!editor) await initEditor();
  importFlow(currentFlow);
  zoomToFit();
}
async function initEditor(){
  const src = 'https://cdn.jsdelivr.net/gh/jerosoler/Drawflow@0.0.58/dist/drawflow.min.js';
  await import(src);
  const el = document.getElementById('drawflow');
  editor = new Drawflow(el);
  editor.reroute=true; editor.start();
  editor.on('nodeSelected',id=>showNodeProperties(id));
  editor.on('nodeUnselected',()=>closeProperties());
  editor.on('nodeCreated',pushUndo);
  editor.on('nodeRemoved',pushUndo);
  editor.on('nodeMoved',pushUndo);
  editor.on('connectionCreated',pushUndo);
  editor.on('connectionRemoved',pushUndo);
}
function pushUndo(){ if(undoing)return; redoStack=[]; undoStack.push(editor.export()); if(undoStack.length>50)undoStack.shift(); }
function undo(){ if(!undoStack.length)return; redoStack.push(editor.export()); const data=undoStack.pop(); undoing=true; editor.clear(); editor.import(data); undoing=false; }
function redo(){ if(!redoStack.length)return; undoStack.push(editor.export()); const data=redoStack.pop(); undoing=true; editor.clear(); editor.import(data); undoing=false; }
function zoomToFit(){
  const padding=60;
  const nodes=editor.editor_selected?Object.values(editor.export().drawflow.Home.data):[];
  if(!nodes.length)return;
  let minX=1e9,minY=1e9,maxX=0,maxY=0;
  nodes.forEach(n=>{
    minX=Math.min(minX,n.pos_x); minY=Math.min(minY,n.pos_y);
    maxX=Math.max(maxX,n.pos_x+100); maxY=Math.max(maxY,n.pos_y+100);
  });
  const cw=editor.precanvas.clientWidth,ch=editor.precanvas.clientHeight;
  const scale=Math.min((cw-padding)/(maxX-minX),(ch-padding)/(maxY-minY),1);
  editor.zoom=scale; editor.precanvas.style.transform=`translate(${-minX*scale+cw/2-(maxX-minX)*scale/2}px, ${-minY*scale+ch/2-(maxY-minY)*scale/2}px) scale(${scale})`;
}

/* --------------  PALETTE -------------- */
function renderPalette(){
  const cats={}; for(const[tpl,data]of Object.entries(nodeTemplates)){if(!cats[data.cat])cats[data.cat]=[];cats[data.cat].push({type:tpl,...data})}
  const html=Object.entries(cats).map(([cat,list])=>`<div class="node-category"><div class="category-title">${cat}</div><div class="node-grid">${list.map(n=>`<div class="node-item" data-key="${n.type}" onclick="addNode('${n.type}')"><div class="node-item-icon" style="background:${n.color}">${n.icon}</div><div>${n.name}</div></div>`).join('')}</div></div>`).join('');
  document.getElementById('nodePaletteContent').innerHTML=html;
}
function showNodePalette(){document.getElementById('nodePalette').classList.add('active');}
function closeNodePalette(){document.getElementById('nodePalette').classList.remove('active');}
function filterPalette(){
  const q=document.getElementById('paletteSearch').value.toLowerCase();
  document.querySelectorAll('.node-item').forEach(el=>el.style.display=el.dataset.key.includes(q)?'flex':'none');
}
function addNode(type){
  const tpl=nodeTemplates[type];
  const data={type,name:tpl.name,config:getDefaultConfig(type)};
  const html=`<div class="node-content"><div class="node-icon-wrapper" style="background:${tpl.color}"><div class="node-icon">${tpl.icon}</div></div><div class="node-name">${tpl.name}</div></div>`;
  const cx=window.innerWidth/2,cy=window.innerHeight/2;
  const id=`${type}-${Date.now()}`;
  editor.addNode(id,tpl.inputs,tpl.outputs,cx-50+Math.random()*100-50,cy-50+Math.random()*100-50,'',data,html,false);
  closeNodePalette(); pushUndo();
}
function getDefaultConfig(t){
  const map={
    'http-in':{method:'post',url:'/endpoint'},
    'http-request':{method:'GET',url:'',timeout:30000},
    function:{func:'return msg;',outputs:1},
    delay:{timeout:1000,timeoutUnits:'milliseconds'},
    inject:{payload:'',payloadType:'date'},
    template:{template:'',syntax:'mustache'},
    switch:{property:'payload',rules:[]},
    change:{rules:[]},
    context:{operation:'get',scope:'flow',key:''}
  };
  return map[t]||{};
}

/* --------------  PROPERTIES -------------- */
function showNodeProperties(id){
  const node=editor.getNodeFromId(id); if(!node)return;
  const tpl=nodeTemplates[node.data.type];
  const isMobile=window.innerWidth<=768;
  const panel=document.getElementById('propertiesPanel');
  const content=document.getElementById('propertiesContent');
  let html=`<div class="form-group"><label class="form-label">Name</label><input class="form-input" value="${node.data.name||''}" onchange="updateNodeProp('${id}','name',this.value)"/></div>`;
  html+=renderFields(node.data.type,node.data.config||{},id);
  html+=`<div style="margin-top:1.5rem;border-top:1px solid var(--b);padding-top:1rem"><button class="btn btn-danger" style="width:100%" onclick="deleteNode('${id}')">üóë Delete</button></div>`;
  content.innerHTML=html;
  if(isMobile){ document.getElementById('helpModal').querySelector('.modal-content').innerHTML=html+'<div style="margin-top:1rem"><button class="btn" onclick="closeModal(\'helpModal\')">Close</button></div>'; showHelp(); }
  else panel.classList.add('active');
}
function closeProperties(){document.getElementById('propertiesPanel').classList.remove('active');}
function renderFields(type,config,id){
  switch(type){
    case'http-in':return`
      <div class="form-group"><label class="form-label">Path</label><input class="form-input" value="${config.url||''}" onchange="updateNodeConfig('${id}','url',this.value)"/></div>
      <div class="form-group"><label class="form-label">Method</label><select class="form-select" onchange="updateNodeConfig('${id}','method',this.value)"><option value="get"${config.method==='get'?' selected':''}>GET</option><option value="post"${config.method==='post'?' selected':''}>POST</option><option value="put"${config.method==='put'?' selected':''}>PUT</option><option value="delete"${config.method==='delete'?' selected':''}>DELETE</option></select></div>`;
    case'http-request':return`
      <div class="form-group"><label class="form-label">URL</label><input class="form-input" value="${config.url||''}" onchange="updateNodeConfig('${id}','url',this.value)"/></div>
      <div class="form-group"><label class="form-label">Method</label><select class="form-select" onchange="updateNodeConfig('${id}','method',this.value)"><option value="GET"${config.method==='GET'?' selected':''}>GET</option><option value="POST"${config.method==='POST'?' selected':''}>POST</option><option value="PUT"${config.method==='PUT'?' selected':''}>PUT</option><option value="DELETE"${config.method==='DELETE'?' selected':''}>DELETE</option></select></div>`;
    case'function':return`<div class="form-group"><label class="form-label">Function</label><textarea class="form-textarea" style="min-height:200px" onchange="updateNodeConfig('${id}','func',this.value)">${config.func||'return msg;'}</textarea></div>`;
    case'delay':return`
      <div class="form-group"><label class="form-label">Delay</label><input type="number" class="form-input" value="${config.timeout||1000}" onchange="updateNodeConfig('${id}','timeout',parseInt(this.value))"/></div>
      <div class="form-group"><label class="form-label">Units</label><select class="form-select" onchange="updateNodeConfig('${id}','timeoutUnits',this.value)"><option value="milliseconds"${config.timeoutUnits==='milliseconds'?' selected':''}>Milliseconds</option><option value="seconds"${config.timeoutUnits==='seconds'?' selected':''}>Seconds</option><option value="minutes"${config.timeoutUnits==='minutes'?' selected':''}>Minutes</option></select></div>`;
    default:return'<p style="color:var(--tm);text-align:center;padding:1rem">No extra properties</p>';
  }
}
function updateNodeProp(id,k,v){const n=editor.getNodeFromId(id); n.data[k]=v; editor.updateNodeDataFromId(id,n.data); pushUndo();}
function updateNodeConfig(id,k,v){const n=editor.getNodeFromId(id); if(!n.data.config)n.data.config={}; n.data.config[k]=v; editor.updateNodeDataFromId(id,n.data);}
function deleteNode(id){if(!confirm('Delete node?'))return; editor.removeNodeId(id); closeProperties(); pushUndo();}

/* --------------  IMPORT / EXPORT -------------- */
function exportFlow(){
  const exp=editor.export();
  const nodes=[];
  for(const[id,node]of Object.entries(exp.drawflow.Home.data)){
    const tpl=nodeTemplates[node.data.type];
    const wires=Array(tpl.outputs).fill(null).map(()=>[]);
    for(const[outputKey,output]of Object.entries(node.outputs||{})){
      const idx=parseInt(outputKey.replace('output_',''))-1;
      if(idx>=0&&idx<wires.length)wires[idx]=output.connections.map(c=>c.node);
    }
    nodes.push({id,type:node.data.type,name:node.data.name||tpl.name,...node.data.config,x:node.pos_x,y:node.pos_y,wires});
  }
  return {id:currentFlow?.id||'new-flow',name:currentFlow?.name||'New Flow',description:currentFlow?.description||'',version:'1.0.0',nodes};
}
function importFlow(flow){
  editor.clear();
  const cfg=typeof flow.config==='string'?JSON.parse(flow.config):flow.config;
  if(!cfg.nodes||!cfg.nodes.length)return;
  cfg.nodes.forEach(n=>{
    const tpl=nodeTemplates[n.type]; if(!tpl)return;
    const data={type:n.type,name:n.name||tpl.name,config:{...n}};
    const html=`<div class="node-content"><div class="node-icon-wrapper" style="background:${tpl.color}"><div class="node-icon">${tpl.icon}</div></div><div class="node-name">${data.name}</div></div>`;
    editor.addNode(n.id,tpl.inputs,tpl.outputs,n.x||100,n.y||100,'',data,html,false);
  });
  cfg.nodes.forEach(n=>{
    if(!n.wires||!Array.isArray(n.wires))return;
    n.wires.forEach((group,idx)=>{
      if(!Array.isArray(group))return;
      group.forEach(target=>{
        const targetNode=editor.getNodeFromId(target);
        if(targetNode)editor.addConnection(n.id,target,`output_${idx+1}`,'input_1');
      });
    });
  });
}
async function saveFlow(){
  const flow=exportFlow();
  if(!flow.id||!flow.name){showToast('ID and name required','error');return;}
  try{
    const method=currentFlow?'PUT':'POST';
    const url=currentFlow?`${API_BASE}/admin/flows/${currentFlow.id}`:`${API_BASE}/admin/flows`;
    const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(flow)});
    const data=await res.json();
    if(data.success){currentFlow=flow;showToast('Saved','success');}
    else showToast(data.error||'Save failed','error');
  }catch(e){showToast('Error saving','error');}
}

/* --------------  FLOW CRUD -------------- */
function showNewFlowModal(){document.getElementById('newFlowModal').classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
function showHelp(){document.getElementById('helpModal').classList.add('active');}
async function createNewFlow(){
  const id=document.getElementById('newFlowId').value.trim();
  const name=document.getElementById('newFlowName').value.trim();
  const desc=document.getElementById('newFlowDesc').value.trim();
  if(!id||!name){showToast('ID and name required','error');return;}
  const flow={id,name,description:desc,nodes:[]};
  try{
    const res=await fetch(`${API_BASE}/admin/flows`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(flow)});
    const data=await res.json();
    if(data.success){closeModal('newFlowModal');showToast('Flow created','success');await loadFlows();openFlow(id);}
    else showToast(data.error||'Failed','error');
  }catch(e){showToast('Error creating','error');}
}
async function duplicateFlow(id){
  const f=flows.find(x=>x.id===id); if(!f)return;
  try{
    const res=await fetch(`${API_BASE}/admin/flows/${id}`);
    const data=await res.json();
    const newId=`${f.id}-copy-${Date.now()}`;
    const flow={...data,id:newId,name:f.name+' (Copy)'};
    const r=await fetch(`${API_BASE}/admin/flows`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(flow)});
    if(r.ok){showToast('Duplicated','success');loadFlows();}
  }catch(e){showToast('Dup failed','error');}
}
async function toggleFlow(id,enable){
  try{
    const res=await fetch(`${API_BASE}/admin/flows/${id}/${enable?'enable':'disable'}`,{method:'POST'});
    if(res.ok){showToast(`Flow ${enable?'enabled':'disabled'}`,'success');loadFlows();}
  }catch(e){showToast('Toggle failed','error');}
}
async function deleteFlow(id){
  const f=flows.find(x=>x.id===id);
  if(!confirm(`Delete ‚Äú${f.name}‚Äù?`))return;
  try{
    const res=await fetch(`${API_BASE}/admin/flows/${id}`,{method:'DELETE'});
    if(res.ok){showToast('Deleted','success');loadFlows();}
  }catch(e){showToast('Delete failed','error');}
}
function showToast(msg,type='info'){
  const icons={success:'‚úì',error:'‚úï',info:'‚Ñπ'};
  const t=document.createElement('div'); t.className=`toast ${type}`;
  t.innerHTML=`<div class="toast-icon">${icons[type]||'‚Ñπ'}</div><div class="toast-message">${msg}</div>`;
  document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
}

/* --------------  KEYBOARD -------------- */
document.addEventListener('keydown',e=>{
  if(e.ctrlKey||e.metaKey){
    if(e.key==='s'&&currentFlow){e.preventDefault();saveFlow();}
    if(e.key==='z'){e.preventDefault();undo();}
    if(e.key==='y'){e.preventDefault();redo();}
  }
});

/* --------------  PALETTE INIT -------------- */
renderPalette();
</script>
</body>
</html>
